<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SignalForge üî• - Job Signal Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-900 text-gray-100">
    <div x-data="dashboard()" x-init="init()" class="min-h-screen">
      <!-- Navigation -->
      <nav class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <h1 class="text-2xl font-bold text-orange-500">üî• SignalForge</h1>
              <span class="text-sm text-gray-400"
                >Real-time Job Signal Engine</span
              >
            </div>
            <div class="flex space-x-4">
              <button
                @click="currentView = 'dashboard'"
                :class="currentView === 'dashboard' ? 'bg-orange-600' : 'bg-gray-700'"
                class="px-4 py-2 rounded-lg hover:bg-orange-500 transition"
              >
                <i class="fas fa-home mr-2"></i>Dashboard
              </button>
              <button
                @click="currentView = 'jobs'"
                :class="currentView === 'jobs' ? 'bg-orange-600' : 'bg-gray-700'"
                class="px-4 py-2 rounded-lg hover:bg-orange-500 transition"
              >
                <i class="fas fa-briefcase mr-2"></i>Jobs
              </button>
              <button
                @click="currentView = 'trends'"
                :class="currentView === 'trends' ? 'bg-orange-600' : 'bg-gray-700'"
                class="px-4 py-2 rounded-lg hover:bg-orange-500 transition"
              >
                <i class="fas fa-chart-line mr-2"></i>Trends
              </button>
              <button
                @click="triggerCollection()"
                class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-500 transition"
              >
                <i class="fas fa-sync-alt mr-2"></i>Collect
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Dashboard View -->
      <div
        x-show="currentView === 'dashboard'"
        class="container mx-auto px-4 py-8"
      >
        <h2 class="text-3xl font-bold mb-6">üìä Dashboard Overview</h2>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Total Jobs</p>
                <p
                  class="text-3xl font-bold text-blue-400"
                  x-text="stats.total_jobs"
                ></p>
              </div>
              <i class="fas fa-briefcase text-4xl text-blue-400"></i>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">High Score Jobs</p>
                <p
                  class="text-3xl font-bold text-green-400"
                  x-text="stats.high_score_count"
                ></p>
              </div>
              <i class="fas fa-star text-4xl text-green-400"></i>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Avg Score</p>
                <p
                  class="text-3xl font-bold text-purple-400"
                  x-text="stats.average_score?.toFixed(1) || '0'"
                ></p>
              </div>
              <i class="fas fa-chart-bar text-4xl text-purple-400"></i>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Remote Jobs</p>
                <p
                  class="text-3xl font-bold text-orange-400"
                  x-text="stats.remote_jobs || '0'"
                ></p>
              </div>
              <i class="fas fa-globe text-4xl text-orange-400"></i>
            </div>
          </div>
        </div>

        <!-- Recent High Score Jobs -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h3 class="text-xl font-bold mb-4">üî• Top Scoring Jobs</h3>
          <div class="space-y-4">
            <template x-for="job in topJobs" :key="job.id">
              <div
                class="bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition cursor-pointer"
                @click="viewJobDetails(job)"
              >
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h4 class="font-semibold text-lg" x-text="job.title"></h4>
                    <p class="text-gray-400 text-sm" x-text="job.company"></p>
                    <div class="flex items-center space-x-4 mt-2 text-sm">
                      <span class="text-gray-400">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        <span x-text="job.location"></span>
                      </span>
                      <span class="text-gray-400">
                        <i class="fas fa-clock mr-1"></i>
                        <span x-text="formatDate(job.posted_at)"></span>
                      </span>
                    </div>
                  </div>
                  <div class="flex items-center space-x-4">
                    <div class="text-right">
                      <p
                        class="text-2xl font-bold"
                        :class="job.score >= 70 ? 'text-green-400' : job.score >= 50 ? 'text-yellow-400' : 'text-gray-400'"
                        x-text="job.score"
                      ></p>
                      <p class="text-xs text-gray-400">score</p>
                    </div>
                    <a
                      :href="job.url"
                      target="_blank"
                      class="px-4 py-2 bg-orange-600 rounded-lg hover:bg-orange-500 transition"
                      @click.stop
                    >
                      View Job
                    </a>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Jobs View -->
      <div x-show="currentView === 'jobs'" class="container mx-auto px-4 py-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-3xl font-bold">üíº All Jobs</h2>
          <div class="flex space-x-4">
            <input
              type="text"
              x-model="filters.search"
              @input="fetchJobs()"
              placeholder="Search jobs..."
              class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:border-orange-500"
            />
            <select
              x-model="filters.minScore"
              @change="fetchJobs()"
              class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:border-orange-500"
            >
              <option value="0">All Scores</option>
              <option value="50">50+</option>
              <option value="60">60+</option>
              <option value="70">70+</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
          <template x-for="job in jobs" :key="job.id">
            <div
              class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-orange-500 transition"
            >
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center space-x-3 mb-2">
                    <h3 class="text-xl font-semibold" x-text="job.title"></h3>
                    <span
                      class="px-2 py-1 bg-gray-700 rounded text-xs"
                      x-text="job.source"
                    ></span>
                  </div>
                  <p class="text-gray-300 mb-3" x-text="job.company"></p>
                  <div class="flex flex-wrap gap-4 text-sm text-gray-400">
                    <span>
                      <i class="fas fa-map-marker-alt mr-1"></i>
                      <span x-text="job.location"></span>
                    </span>
                    <span>
                      <i class="fas fa-clock mr-1"></i>
                      <span x-text="formatDate(job.posted_at)"></span>
                    </span>
                    <span x-show="job.stack">
                      <i class="fas fa-code mr-1"></i>
                      <span x-text="job.stack"></span>
                    </span>
                  </div>
                </div>
                <div class="flex items-center space-x-4 ml-6">
                  <div class="text-center">
                    <div
                      class="text-3xl font-bold"
                      :class="job.score >= 70 ? 'text-green-400' : job.score >= 50 ? 'text-yellow-400' : 'text-gray-400'"
                      x-text="job.score"
                    ></div>
                    <div class="text-xs text-gray-400">score</div>
                  </div>
                  <a
                    :href="job.url"
                    target="_blank"
                    class="px-4 py-2 bg-orange-600 rounded-lg hover:bg-orange-500 transition whitespace-nowrap"
                  >
                    <i class="fas fa-external-link-alt mr-2"></i>View
                  </a>
                </div>
              </div>
            </div>
          </template>
        </div>

        <div x-show="jobs.length === 0" class="text-center py-12 text-gray-400">
          <i class="fas fa-inbox text-6xl mb-4"></i>
          <p class="text-xl">
            No jobs found. Try adjusting your filters or collect new jobs.
          </p>
        </div>
      </div>

      <!-- Trends View -->
      <div
        x-show="currentView === 'trends'"
        class="container mx-auto px-4 py-8"
      >
        <h2 class="text-3xl font-bold mb-6">üìà Market Trends</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Top Keywords -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">üîù Trending Keywords</h3>
            <div class="space-y-2">
              <template
                x-for="[keyword, count] in trends.trending_keywords || []"
                :key="keyword"
              >
                <div class="flex items-center justify-between">
                  <span class="capitalize" x-text="keyword"></span>
                  <div class="flex items-center space-x-2">
                    <div class="w-32 bg-gray-700 rounded-full h-2">
                      <div
                        class="bg-orange-500 h-2 rounded-full"
                        :style="`width: ${(count / (trends.trending_keywords?.[0]?.[1] || 1)) * 100}%`"
                      ></div>
                    </div>
                    <span
                      class="text-orange-400 font-semibold w-8 text-right"
                      x-text="count"
                    ></span>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Top Technologies -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">üíª Top Technologies</h3>
            <div class="space-y-2">
              <template
                x-for="[tech, count] in (trends.top_technologies || []).slice(0, 10)"
                :key="tech"
              >
                <div class="flex items-center justify-between">
                  <span class="capitalize" x-text="tech"></span>
                  <div class="flex items-center space-x-2">
                    <div class="w-32 bg-gray-700 rounded-full h-2">
                      <div
                        class="bg-blue-500 h-2 rounded-full"
                        :style="`width: ${(count / (trends.top_technologies?.[0]?.[1] || 1)) * 100}%`"
                      ></div>
                    </div>
                    <span
                      class="text-blue-400 font-semibold w-8 text-right"
                      x-text="count"
                    ></span>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Top Companies -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">üè¢ Top Hiring Companies</h3>
            <div class="space-y-2">
              <template
                x-for="[company, count] in trends.top_hiring_companies || []"
                :key="company"
              >
                <div class="flex items-center justify-between">
                  <span x-text="company"></span>
                  <span
                    class="text-green-400 font-semibold"
                    x-text="count + ' positions'"
                  ></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Top Locations -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">üìç Top Locations</h3>
            <div class="space-y-2">
              <template
                x-for="[location, count] in trends.top_locations || []"
                :key="location"
              >
                <div class="flex items-center justify-between">
                  <span x-text="location"></span>
                  <span
                    class="text-purple-400 font-semibold"
                    x-text="count + ' jobs'"
                  ></span>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Summary Stats -->
        <div class="mt-6 bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h3 class="text-xl font-bold mb-4">üìä Analysis Summary</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p class="text-gray-400 text-sm">Total Analyzed</p>
              <p
                class="text-2xl font-bold text-blue-400"
                x-text="trends.total_jobs_analyzed || 0"
              ></p>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Recent Jobs (3d)</p>
              <p
                class="text-2xl font-bold text-green-400"
                x-text="trends.recent_job_count || 0"
              ></p>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Unique Companies</p>
              <p
                class="text-2xl font-bold text-purple-400"
                x-text="(trends.top_hiring_companies || []).length"
              ></p>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Last Updated</p>
              <p
                class="text-sm text-orange-400"
                x-text="formatDate(trends.analysis_timestamp)"
              ></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div
        x-show="loading"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-gray-800 rounded-lg p-8 text-center">
          <i class="fas fa-spinner fa-spin text-4xl text-orange-500 mb-4"></i>
          <p class="text-xl">Loading...</p>
        </div>
      </div>

      <!-- Toast Notification -->
      <div
        x-show="toast.show"
        x-transition
        class="fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-lg z-50 max-w-md"
      >
        <div class="flex items-center space-x-3">
          <i
            :class="toast.type === 'success' ? 'fas fa-check-circle text-green-400' : 'fas fa-exclamation-circle text-red-400'"
            class="text-2xl"
          ></i>
          <p x-text="toast.message"></p>
        </div>
      </div>
    </div>

    <script>
      function dashboard() {
        return {
          currentView: "dashboard",
          loading: false,
          stats: {},
          jobs: [],
          topJobs: [],
          trends: {},
          filters: {
            search: "",
            minScore: 0,
          },
          toast: {
            show: false,
            message: "",
            type: "success",
          },

          async init() {
            await this.fetchStats();
            await this.fetchJobs();
            await this.fetchTrends();
          },

          async fetchStats() {
            try {
              const response = await fetch("/api/jobs/stats/summary");
              this.stats = await response.json();
            } catch (error) {
              console.error("Error fetching stats:", error);
            }
          },

          async fetchJobs() {
            this.loading = true;
            try {
              let url = `/api/jobs?limit=100`; 
              if (this.filters.minScore > 0) {
                url += `&min_score=${this.filters.minScore}`;
              }
              const response = await fetch(url);
              const data = await response.json();
              this.jobs = data.jobs || [];
              this.topJobs = this.jobs.slice(0, 5);
            } catch (error) {
              console.error("Error fetching jobs:", error);
              this.showToast("Error fetching jobs", "error");
            } finally {
              this.loading = false;
            }
          },

          async fetchTrends() {
            try {
              // Call a new endpoint or compute trends from jobs
              this.trends = this.computeTrends(this.jobs);
            } catch (error) {
              console.error("Error fetching trends:", error);
            }
          },

          computeTrends(jobs) {
            const keywords = {};
            const companies = {};
            const locations = {};
            const techs = {};

            jobs.forEach((job) => {
              // Count companies
              companies[job.company] = (companies[job.company] || 0) + 1;

              // Count locations
              locations[job.location] = (locations[job.location] || 0) + 1;

              // Count tech stack
              if (job.stack) {
                const stackItems = job.stack.split(",");
                stackItems.forEach((tech) => {
                  const t = tech.trim().toLowerCase();
                  if (t) techs[t] = (techs[t] || 0) + 1;
                });
              }
            });

            return {
              trending_keywords: Object.entries(keywords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10),
              top_technologies: Object.entries(techs)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10),
              top_hiring_companies: Object.entries(companies)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10),
              top_locations: Object.entries(locations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10),
              total_jobs_analyzed: jobs.length,
              recent_job_count: jobs.filter((j) => {
                const posted = new Date(j.posted_at);
                const threeDaysAgo = new Date();
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                return posted >= threeDaysAgo;
              }).length,
              analysis_timestamp: new Date().toISOString(),
            };
          },

          async triggerCollection() {
            this.loading = true;
            this.showToast("Starting job collection...", "success");

            try {
              const resp = await fetch("/api/jobs/collect", { method: "POST" });
              if (!resp.ok) {
                this.showToast("Failed to start collection", "error");
              } else {
                const data = await resp.json();
                if (data.started) {
                  this.showToast("Collection started! Refreshing data...", "success");
                  await this.init();
                } else {
                  this.showToast("Collection not started", "error");
                }
              }
            } catch (error) {
              console.error("Collection error:", error);
              this.showToast("Collection failed", "error");
            } finally {
              this.loading = false;
            }
          },

          formatDate(dateStr) {
            if (!dateStr) return "N/A";
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
          },

          showToast(message, type = "success") {
            this.toast = { show: true, message, type };
            setTimeout(() => {
              this.toast.show = false;
            }, 3000);
          },

          viewJobDetails(job) {
            window.open(job.url, "_blank");
          },
        };
      }
    </script>
  </body>
</html>
